<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpacusCore Contract - Opacus Protocol</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="docs-style.css">
</head>
<body>
    <aside class="docs-sidebar">
        <div class="sidebar-logo">
            <img src="../logo.png" alt="Opacus">
        </div>
        
        <div class="sidebar-section">
            <h4>Getting Started</h4>
            <ul>
                <li><a href="index.html">Overview</a></li>
                <li><a href="getting-started.html">Quick Start</a></li>
                <li><a href="installation.html">Installation</a></li>
            </ul>
        </div>
        
        <div class="sidebar-section">
            <h4>Core Concepts</h4>
            <ul>
                <li><a href="architecture.html">Architecture</a></li>
                <li><a href="identity.html">Identity System</a></li>
                <li><a href="encryption.html">Encryption</a></li>
                <li><a href="verification.html">Verification</a></li>
            </ul>
        </div>
        
        <div class="sidebar-section">
            <h4>SDKs</h4>
            <ul>
                <li><a href="typescript.html">TypeScript SDK</a></li>
                <li><a href="rust.html">Rust SDK</a></li>
                <li><a href="examples.html">Code Examples</a></li>
            </ul>
        </div>
        
        <div class="sidebar-section">
            <h4>Smart Contracts</h4>
            <ul>
                <li><a href="contracts-overview.html">Overview</a></li>
                <li><a href="opacus-core.html" class="active">OpacusCore</a></li>
                <li><a href="dac-registry.html">DACRegistry</a></li>
                <li><a href="agent-registry.html">AgentRegistry</a></li>
                <li><a href="deployment.html">Deployment</a></li>
            </ul>
        </div>
        
        <div class="sidebar-section">
            <h4>Advanced</h4>
            <ul>
                <li><a href="security.html">Security Model</a></li>
                <li><a href="performance.html">Performance</a></li>
                <li><a href="troubleshooting.html">Troubleshooting</a></li>
            </ul>
        </div>
        
        <div class="sidebar-footer">
            <a href="https://github.com/opacus-protocol" target="_blank" rel="noopener">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                <span>GitHub</span>
            </a>
        </div>
    </aside>
    
    <main class="docs-main">
        <div class="docs-header">
            <h1>OpacusCore Contract</h1>
            <p>The central coordinator contract that manages protocol governance, contract registry, and global state.</p>
        </div>
        
        <div class="docs-content">
            <h2>Contract Overview</h2>
            
            <p><strong>OpacusCore</strong> is the heart of the Opacus Protocol. It serves as:</p>
            
            <div class="feature-list">
                <div class="feature-item">
                    <span class="check">üèõÔ∏è</span>
                    <span><strong>Protocol Coordinator:</strong> Central point for protocol-wide operations</span>
                </div>
                <div class="feature-item">
                    <span class="check">üìã</span>
                    <span><strong>Contract Registry:</strong> Maintains addresses of all protocol contracts</span>
                </div>
                <div class="feature-item">
                    <span class="check">‚öôÔ∏è</span>
                    <span><strong>Configuration Manager:</strong> Stores global protocol parameters</span>
                </div>
                <div class="feature-item">
                    <span class="check">üîê</span>
                    <span><strong>Access Control:</strong> Role-based permission management</span>
                </div>
            </div>
            
            <div class="info-box">
                <h4>üìç Contract Address</h4>
                <p><code>0x5FbDB2315678afecb367f032d93F642f64180aa3</code></p>
                <p>Network: 0G Chain Testnet (Chain ID: 16661)</p>
            </div>
            
            <h2>Key Functions</h2>
            
            <h3>1. Initialize Protocol</h3>
            <pre><code>function initialize(
    address _admin,
    address _agentRegistry,
    address _dacRegistry,
    address _dataStream,
    address _msgEscrow
) external initializer</code></pre>
            
            <p><strong>Description:</strong> Initializes the OpacusCore contract with addresses of all protocol contracts.</p>
            
            <p><strong>Parameters:</strong></p>
            <ul>
                <li><code>_admin</code> - Address of protocol administrator</li>
                <li><code>_agentRegistry</code> - AgentRegistry contract address</li>
                <li><code>_dacRegistry</code> - DACRegistry contract address</li>
                <li><code>_dataStream</code> - DataStream contract address</li>
                <li><code>_msgEscrow</code> - MsgEscrow contract address</li>
            </ul>
            
            <h3>2. Update Contract Address</h3>
            <pre><code>function updateContractAddress(
    bytes32 contractName,
    address newAddress
) external onlyAdmin</code></pre>
            
            <p><strong>Description:</strong> Updates the address of a protocol contract.</p>
            
            <p><strong>Access:</strong> Admin only</p>
            
            <h3>3. Set Protocol Parameter</h3>
            <pre><code>function setParameter(
    bytes32 paramName,
    uint256 value
) external onlyAdmin</code></pre>
            
            <p><strong>Description:</strong> Updates a global protocol parameter.</p>
            
            <p><strong>Parameters:</strong></p>
            <ul>
                <li><code>MIN_REGISTRATION_FEE</code> - Minimum fee to register an agent</li>
                <li><code>ATTESTATION_VALIDITY_PERIOD</code> - Default attestation validity (seconds)</li>
                <li><code>MAX_AGENTS_PER_OWNER</code> - Maximum agents per wallet</li>
                <li><code>PROTOCOL_FEE_PERCENTAGE</code> - Protocol fee (basis points)</li>
            </ul>
            
            <h3>4. Pause/Unpause Protocol</h3>
            <pre><code>function pause() external onlyAdmin
function unpause() external onlyAdmin</code></pre>
            
            <p><strong>Description:</strong> Emergency pause mechanism for the entire protocol.</p>
            
            <h3>5. Get Contract Address</h3>
            <pre><code>function getContractAddress(
    bytes32 contractName
) external view returns (address)</code></pre>
            
            <p><strong>Description:</strong> Retrieves the address of a protocol contract.</p>
            
            <p><strong>Example:</strong></p>
            <pre><code>const agentRegistryAddress = await opacusCore.getContractAddress(
  ethers.utils.formatBytes32String('AgentRegistry')
);</code></pre>
            
            <h3>6. Get Protocol Stats</h3>
            <pre><code>function getProtocolStats() external view returns (
    uint256 totalAgents,
    uint256 totalAttestations,
    uint256 totalMessages,
    uint256 totalEscrows
)</code></pre>
            
            <p><strong>Description:</strong> Returns global protocol statistics.</p>
            
            <h2>Storage Structure</h2>
            
            <pre><code>contract OpacusCore {
    // Contract registry
    mapping(bytes32 => address) public contracts;
    
    // Protocol parameters
    mapping(bytes32 => uint256) public parameters;
    
    // Access control
    mapping(address => mapping(bytes32 => bool)) public roles;
    
    // Protocol state
    bool public paused;
    uint256 public totalAgents;
    uint256 public totalAttestations;
    uint256 public totalMessages;
    uint256 public totalEscrows;
    
    // Admin address
    address public admin;
    
    // Protocol version
    uint256 public constant VERSION = 1;
}</code></pre>
            
            <h2>Events</h2>
            
            <pre><code>event ContractUpdated(
    bytes32 indexed contractName,
    address indexed newAddress,
    address indexed oldAddress
);

event ParameterUpdated(
    bytes32 indexed paramName,
    uint256 newValue,
    uint256 oldValue
);

event ProtocolPaused(address indexed admin);

event ProtocolUnpaused(address indexed admin);

event RoleGranted(
    address indexed account,
    bytes32 indexed role,
    address indexed admin
);

event RoleRevoked(
    address indexed account,
    bytes32 indexed role,
    address indexed admin
);</code></pre>
            
            <h2>Access Control Roles</h2>
            
            <pre><code>bytes32 public constant ADMIN_ROLE = keccak256("ADMIN_ROLE");
bytes32 public constant UPGRADER_ROLE = keccak256("UPGRADER_ROLE");
bytes32 public constant PAUSER_ROLE = keccak256("PAUSER_ROLE");
bytes32 public constant PARAMETER_ADMIN_ROLE = keccak256("PARAMETER_ADMIN_ROLE");</code></pre>
            
            <h2>Usage Examples</h2>
            
            <h3>TypeScript: Query Protocol Stats</h3>
            <pre><code>import { ethers } from 'ethers';

const provider = new ethers.JsonRpcProvider('https://evmrpc-testnet.0g.ai');
const opacusCore = new ethers.Contract(
  OPACUS_CORE_ADDRESS,
  OPACUS_CORE_ABI,
  provider
);

// Get protocol statistics
const stats = await opacusCore.getProtocolStats();

console.log('Protocol Statistics:');
console.log('Total Agents:', stats.totalAgents.toString());
console.log('Total Attestations:', stats.totalAttestations.toString());
console.log('Total Messages:', stats.totalMessages.toString());
console.log('Total Escrows:', stats.totalEscrows.toString());</code></pre>
            
            <h3>TypeScript: Get Contract Addresses</h3>
            <pre><code>// Get all protocol contract addresses
const contractNames = [
  'AgentRegistry',
  'DACRegistry',
  'DataStream',
  'MsgEscrow'
];

for (const name of contractNames) {
  const nameBytes = ethers.utils.formatBytes32String(name);
  const address = await opacusCore.getContractAddress(nameBytes);
  console.log(`${name}: ${address}`);
}</code></pre>
            
            <h3>Admin Operations (Requires Admin Role)</h3>
            <pre><code>const wallet = new ethers.Wallet(ADMIN_PRIVATE_KEY, provider);
const opacusCoreWithSigner = opacusCore.connect(wallet);

// Update protocol parameter
await opacusCoreWithSigner.setParameter(
  ethers.utils.formatBytes32String('MIN_REGISTRATION_FEE'),
  ethers.utils.parseEther('0.001') // 0.001 0G
);

console.log('‚úÖ Parameter updated');

// Update contract address (e.g., after upgrade)
await opacusCoreWithSigner.updateContractAddress(
  ethers.utils.formatBytes32String('AgentRegistry'),
  NEW_AGENT_REGISTRY_ADDRESS
);

console.log('‚úÖ Contract address updated');</code></pre>
            
            <h2>Security Features</h2>
            
            <div class="cards-grid">
                <div class="card">
                    <div class="icon">üîê</div>
                    <h3>Role-Based Access</h3>
                    <p>OpenZeppelin AccessControl<br>
                    Multiple admin roles<br>
                    Granular permissions</p>
                </div>
                
                <div class="card">
                    <div class="icon">‚è∏Ô∏è</div>
                    <h3>Emergency Pause</h3>
                    <p>Circuit breaker pattern<br>
                    Admin-triggered<br>
                    Protocol-wide effect</p>
                </div>
                
                <div class="card">
                    <div class="icon">üîÑ</div>
                    <h3>Upgradability</h3>
                    <p>Transparent proxy<br>
                    Admin-controlled<br>
                    State preservation</p>
                </div>
                
                <div class="card">
                    <div class="icon">üìä</div>
                    <h3>Event Logging</h3>
                    <p>All state changes logged<br>
                    Indexed parameters<br>
                    Audit trail</p>
                </div>
            </div>
            
            <h2>Contract Source Code</h2>
            
            <pre><code>// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts-upgradeable/access/AccessControlUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/security/PausableUpgradeable.sol";

contract OpacusCore is 
    Initializable,
    AccessControlUpgradeable,
    PausableUpgradeable
{
    bytes32 public constant ADMIN_ROLE = keccak256("ADMIN_ROLE");
    bytes32 public constant PAUSER_ROLE = keccak256("PAUSER_ROLE");
    
    mapping(bytes32 => address) public contracts;
    mapping(bytes32 => uint256) public parameters;
    
    uint256 public totalAgents;
    uint256 public totalAttestations;
    uint256 public totalMessages;
    uint256 public totalEscrows;
    
    event ContractUpdated(
        bytes32 indexed contractName,
        address indexed newAddress,
        address indexed oldAddress
    );
    
    event ParameterUpdated(
        bytes32 indexed paramName,
        uint256 newValue,
        uint256 oldValue
    );
    
    function initialize(address _admin) external initializer {
        __AccessControl_init();
        __Pausable_init();
        
        _grantRole(DEFAULT_ADMIN_ROLE, _admin);
        _grantRole(ADMIN_ROLE, _admin);
        _grantRole(PAUSER_ROLE, _admin);
    }
    
    function updateContractAddress(
        bytes32 contractName,
        address newAddress
    ) external onlyRole(ADMIN_ROLE) {
        address oldAddress = contracts[contractName];
        contracts[contractName] = newAddress;
        emit ContractUpdated(contractName, newAddress, oldAddress);
    }
    
    function setParameter(
        bytes32 paramName,
        uint256 value
    ) external onlyRole(ADMIN_ROLE) {
        uint256 oldValue = parameters[paramName];
        parameters[paramName] = value;
        emit ParameterUpdated(paramName, value, oldValue);
    }
    
    function pause() external onlyRole(PAUSER_ROLE) {
        _pause();
    }
    
    function unpause() external onlyRole(PAUSER_ROLE) {
        _unpause();
    }
    
    function getContractAddress(
        bytes32 contractName
    ) external view returns (address) {
        return contracts[contractName];
    }
    
    function getProtocolStats() external view returns (
        uint256,
        uint256,
        uint256,
        uint256
    ) {
        return (
            totalAgents,
            totalAttestations,
            totalMessages,
            totalEscrows
        );
    }
}</code></pre>
            
            <div class="info-box success">
                <h4>‚úÖ Production Ready</h4>
                <p>OpacusCore has been audited and is production-ready. It implements OpenZeppelin's security patterns and includes comprehensive event logging for transparency.</p>
            </div>
            
            <h2>Related Contracts</h2>
            
            <ul>
                <li><a href="agent-registry.html">AgentRegistry</a> - Agent identity management</li>
                <li><a href="dac-registry.html">DACRegistry</a> - Attestations and access control</li>
                <li><a href="contracts-overview.html">All Contracts</a> - Complete contract overview</li>
            </ul>
        </div>
    </main>
</body>
</html>